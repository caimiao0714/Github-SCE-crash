units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver] %>%
.[,shift_id := segment_0(speed = speed, threshold = 8*60, time_diff = diff), driver] %>%
.[trip_id != 0,] %>%
.[,.(start_time = ping_time[1], end_time = ping_time[.N]), .(driver, shift_id, trip_id)] %>%
.[,trip_length := as.numeric(difftime(end_time, start_time, units = "mins"))] %>%
.[,trip_median := start_time + 60*trip_length/2] %>% .[]
knitr::kable(d_trip[1:5,], align = "c",
caption = "Aggregated trips")
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2 <- inverse.rle(r2)
r2 <- rle(r2)
## Then numbering consecutive stretches of non-zero values
r2$values[r2$values] = cumsum(r2$values[r2$values])
return(inverse.rle(r2))
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver] %>%
.[,shift_id := segment_0(speed = speed, threshold = 8*60, time_diff = diff), driver] %>%
.[trip_id != 0,] %>%
.[,.(start_time = ping_time[1], end_time = ping_time[.N]), .(driver, shift_id, trip_id)] %>%
.[,trip_length := as.numeric(difftime(end_time, start_time, units = "mins"))] %>%
.[,trip_median := start_time + 60*trip_length/2] %>% .[]
knitr::kable(d_trip[1:5,], align = "c",
caption = "Aggregated trips")
d_trip
d_trip
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d_trip
d_trip
View(d_trip)
speed = d[,speed]
threshold = 30
d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver]
time_diff = d[,diff]
speed[time_diff >= threshold] <- 0
head(speed)
r1 = rle(speed != 0)
r1
r1$values <- replicate(length(r1$values), 1)
r1
r1$values <- cumsum(r1$values)
r1
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
dat_tmp1
dat_tmp2
r2 = rle(speed != 0)
r2
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2 <- inverse.rle(r2)
r2
r2 <- rle(r2)
r2
d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver]
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver]
View(d_trip)
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1
r1$values <- replicate(length(r1$values), 1)
r1
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
dat_tmp2
r2 = rle(speed != 0)
r2$values
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- inverse.rle(r2)
r2 <- rle(r2)
## Then numbering consecutive stretches of non-zero values
r2$values[r2$values] = cumsum(r2$values[r2$values])
return(inverse.rle(r2))
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2
r2 <- inverse.rle(r2)
r2
r2 <- rle(r2)
r2
r2$values[r2$values] = cumsum(r2$values[r2$values])
r2
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- inverse.rle(r2)
r2 <- rle(r2)
## Then numbering consecutive stretches of non-zero values
r2$values[r2$values] = cumsum(r2$values[r2$values])
return(inverse.rle(r2))
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d
d
d = fread("data/sample_ping.csv") %>%
.[,ping_time := ymd_hms(ping_time)]
d
d
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d = fread("data/sample_ping.csv") %>%
.[,ping_time := ymd_hms(ping_time)] %>%
.[-(266:273),]
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2
r2 <- inverse.rle(r2)
r2 <- rle(r2)
r2
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r3 <- inverse.rle(r2)
r3 <- rle(r3)
identical(r2, r3)
r2
r3
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
## Then numbering consecutive stretches of non-zero values
r2$values[r2$values] = cumsum(r2$values[r2$values])
return(inverse.rle(r2))
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
1:5
z = 1:5
shift(z, 1, NA, "lead")
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
jump_speed = id == 0 & speed != 0
id[jump_speed] = id[data.table::shift(jump_speed, 1, NA, "lead")]
return(id)
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d = fread("data/sample_ping.csv") %>%
.[,ping_time := ymd_hms(ping_time)] %>%
.[-(266:273),]
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
which(id == 0 & speed != 0)
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
id
jump_speed = which(id == 0 & speed != 0)
jump_speed
id[jump_speed] = id[data.table::shift(jump_speed, 1, NA, "lead")]
id
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
jump_speed = which(id == 0 & speed != 0)
id[jump_speed] = id[data.table::shift(jump_speed, 1, NA, "lead")]
return(id)
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d = fread("data/sample_ping.csv") %>%
.[,ping_time := ymd_hms(ping_time)] %>%
.[-(266:273),]
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
View(d_trip)
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver]
speed = d_trip[,speed]
time_diff = d_trip[,diff]
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
jump_speed = which(id == 0 & speed != 0)
jump_speed
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
id
id == 0
speed != 0
z = data.frame(id, speed, id0 = (id == 0), speed0 = (speed != 0))
View(z)
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed1 = speed
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
jump_speed = which(id == 0 & speed1 != 0)
id[jump_speed] = id[data.table::shift(jump_speed, 1, NA, "lead")]
return(id)
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d = fread("data/sample_ping.csv") %>%
.[,ping_time := ymd_hms(ping_time)] %>%
.[-(266:273),]
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver]
speed = d_trip[,speed]
time_diff = d_trip[,diff]
speed1 = speed
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
jump_speed = which(id == 0 & speed1 != 0)
jump_speed
data.table::shift(jump_speed, 1, NA, "lead")
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed1 = speed
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
jump_speed = which(id == 0 & speed1 != 0)
id[jump_speed] = id[jump_speed + 1]
return(id)
}
d_trip = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
pacman::p_load(data.table, dplyr, ggplot2, lubridate)
d = fread("data/sample_ping.csv") %>%
.[,ping_time := ymd_hms(ping_time)]
knitr::kable(d[1:5,], align = "c",
caption = "Sample ping data")
segment_0 = function(speed, threshold, time_diff) {
## Replace very long single points
speed1 = speed
speed[time_diff >= threshold] <- 0
## First, replacing stretches of less than "threshold" consecutive 0 speeds by 1s
r1 = rle(speed != 0)
r1$values <- replicate(length(r1$values), 1)
r1$values <- cumsum(r1$values)
order_tmp <- inverse.rle(r1)
dat_tmp1 <- data.table::data.table(speed, order_tmp, time_diff)
dat_tmp2 <- dat_tmp1[,.(sumdiff = sum(time_diff)), by = order_tmp]
r2 = rle(speed != 0)
first_rle = r2$values[1]
r2$values[r2$values == 0 & dat_tmp2$sumdiff < threshold] <- TRUE
r2$values[1] = first_rle
r2 <- rle(inverse.rle(r2))
r2$values[r2$values] = cumsum(r2$values[r2$values])
id = inverse.rle(r2)
jump_speed = which(id == 0 & speed1 != 0)
id[jump_speed] = id[jump_speed + 1]
return(id)
}
d = d %>%
.[,diff := as.integer(difftime(ping_time, shift(ping_time, type = "lag", fill = 0),
units = "mins")), driver] %>%
.[,diff := {diff[1] = 0L; diff}, driver] %>%
.[,trip_id := segment_0(speed = speed, threshold = 30, time_diff = diff), driver]
d_trip = d %>%
.[trip_id != 0,] %>%
.[,.(start_time = ping_time[1], end_time = ping_time[.N]), .(driver, trip_id)] %>%
.[,trip_length := round(as.numeric(difftime(end_time, start_time, units = "mins")), 2)] %>%
.[,trip_median := start_time + 60*trip_length/2]
d
rep("Trip", 3)
Sys.getlocale("LC_ALL")
rmarkdown::pandoc_version()
